---
title: "Installing and configuring Wazuh"
slug: "installing_wazuh"
tags: [homelab,wazuh]
date: 2024-05-16T23:33:00+03:00
draft: false
---

Wazuh is a really cool free, open source tool that unifies XDR and SIEM capabilities into one neat package. It has features such as vulnerability detection, file integrity monitoring and log data analysis, threat hunting, posture management and a bunch more. I have previously used Wazuh in a professional capacity, and have been meaning to install it into my own environment, which is what this post is about. I will be following the version 4.7 documentation for the service. At the end of the post you can see a rough diagram of the finished setup.

## **Objective**

- Initial installation and configuration
- Vulnerability management for clients, starting with PCs in the network, and later on adding in servers
- File integrity monitoring for PCs
- Plan for more things to continue with later on.

## **Getting started**

Wazuh has really good documentation on their website which is what I'll be using to guide me through the installation of this tool (https://documentation.wazuh.com/current/index.html). There's a few ways to install Wazuh:

- Ready-to-use machines in the form of OVAs; pre-built VM images that can be imported to any OVA compatible virtualization systems
- Amazon Machine Image (AMI), which can be launched directly on an AWS cloud instance
- Containers (Docker or Kubernetes)
- Offline
- From source

Since I have my own homelab, I'll be installing Wazuh there.

Wazuh comprises of three central platform components that'll be running on the installed server(s) and then the **individual agents** that will be installed to each client that I want to be talking with Wazuh:

- **Wazuh indexer** (this component is in charge of indexing and storing alerts that are generated by Wazuh server, and you can set it up either as a single-node, or in a cluster of multiple nodes for higher availability and better redundancy, or in order to gain more capacity for an expanding environment. The indexer is really good for time-sensitive use cases due to it operating in near real-time.)
- **Wazuh server** (this one's job is to analyze the data received from agents, following certain rules and looking for indicators of compromise, IOCs. The server also allows for automated countermeasures such as banning certain IP addresses, stopping a running process or even removing malicious items.)
- **Wazuh dashboard** (this is the GUI element of the tool that can be accessed through the browser. It comes pre-installed with certain dashboards and can be customised a lot; it is the most accessible way of accessing the information handled by all the components of the service, and even allows features for role-based access control as well as single sign-on. By default you may also find dashboards for regulatory compliance for frameworks such as MITRE ATT&CK, PCI DSS and GDPR.)

It's also possible, I just learned, to monitor agent-less devices as well via Syslog, so things such as firewalls or switches, or even an IDS. More information on all of this can be found at https://documentation.wazuh.com/current/getting-started/components/index.html. It also occurs to me now how, interestingly enough, this all could probably be used in a malicious way had an attacker setup Wazuh for their own purposes, since the information transferred by the Wazuh agent is already encrypted by default. 

## **Installation**

There's actually even more ways to install Wazuh than I already discussed; in addition to everything covered before, there is also a quick install which installs every component all at once to one server, or alternatively, you can install each component separately to allow for more flexibility and customization. As recommended by [Wazuh](https://documentation.wazuh.com/current/getting-started/architecture.html#architecture), I'll be installing the Wazuh server and indexer on different hosts. 

(There's also a slightly longer way to install the components in a step-by-step fashion with added steps; I decided to go with the assisted installation instead to get hands on with Wazuh faster.)

Wazuh Indexer can be installed on several flavours of Linux including Red Hat Enterprise Linux 7, 8, 9 and Ubuntu 16.04, 18.04, 20.04, 22.04; I'll be going for the latest Ubuntu server. I remember trying to install all this on Rocky Linux previously as well, and it seemed to work fine.

System requirements for each Wazuh indexer node are as follows:

**Minimum** 4 GB RAM, 2 CPU cores

**Recommended** 16 GB RAM, 8 CPU cores.

The amount of storage required depends on the environment. To get some perspective, according to the documentation, an environment with 80 workstations, 10 servers, and 10 network devices requires about 230 GB for the Wazuh indexer server to store alerts for 90 days. I'll go for 128 GB of space + the recommended specs to start with, since my environment is quite small, with a handful of computers and mostly just servers. I'm installing the whole setup on my DMZ network to keep the rest of my network safe when I will be allowing agents to communitate with Wazuh over the internet later in this post. I'll be using the minimal installation of Ubuntu which I occasionally come to regret as it's sometimes missing some random component that ends up being needed, but I like the fact that there are far fewer things to worry about when it comes to vulnerabilities.

## **Installing Wazuh indexer**

Make sure you have root user privileges in order to do the installation of the indexer.

Following the documentation, download the Wazuh installation assistant and the configuration file:

`curl -sO https://packages.wazuh.com/4.7/wazuh-install.sh` 
`curl -sO https://packages.wazuh.com/4.7/config.yml`

Edit the config.yml file to add in the node names and IPs you'll be using; this needs to be done for all the components and for any additional nodes you'd want to add. Fun fact: I discovered that even if the indexer is going to be installed on the very same server you are doing this on, localhost will not work; you have to actually put in the IP address. Later we will see why this actually makes sense.

After editing the config.yml, run the following command in order to generate the Wazuh cluster key, certs and password necessary to keep going with the process. If you need to look at these files again, they'll be located in ./wazuh-install-files.tar. Again, do note that this command needs to be ran as root, the hashtag signifying that fact:

`# bash wazuh-install.sh --generate-config-files`

The wazuh-install-files.tar needs to be copied to all the different servers where you will be installing the components, so if you are going to be segmenting the components, each component's host will need these files.

Next we'll be installing the indexer node(s). If multiple nodes are desired, this step needs to be repeated for each one, and the wazuh-install-files.tar needs to be present in the working directory. Since I'll keep working on the same server where I already downloaded the wazuh-install.sh and .config.yml + where I have the required files, I'll move onto the next step:

`# bash wazuh-install.sh --wazuh-indexer node-1`

Since this is my first and only node, I'll move onto the cluster initialization, which is the final step of installing either the Wazuh indexer single-node or multi-node cluster:

`# bash wazuh-install.sh --start-cluster`

Personally having been connected to my node through SSH, I was disconnected after running the above command, but checking the /var/log/wazuh-install.log, everything seems to have installed properly, and I can see no noteworthy errors.

Next we will test the cluster installation, and to do so we need to first get the admin password:

`# tar -axf wazuh-install-files.tar wazuh-install-files/wazuh-passwords.txt -O | grep -P "\'admin\'" -A 1`

Then, with the admin password we just got:

`curl -k -u admin:<ADMIN_PASSWORD> https://<WAZUH_INDEXER_IP>:9200`

This should return something like this:

```
{
  "name" : "node-1",
  "cluster_name" : "wazuh-indexer-cluster",
  "cluster_uuid" : "BOeK6QnIRjGXLRWFVetkWg",
  "version" : {
    "number" : "7.10.2",
    "build_type" : "rpm",
    "build_hash" : "db90a415ff2fd428b4f7b3f800a51dc229287cb4",
    "build_date" : "2023-06-03T06:24:25.112415503Z",
    "build_snapshot" : false,
    "lucene_version" : "9.6.0",
    "minimum_wire_compatibility_version" : "7.10.0",
    "minimum_index_compatibility_version" : "7.0.0"
  },
  "tagline" : "The OpenSearch Project: https://opensearch.org/"
}
```
Finally, run the following command to check the cluster is working correctly:

`curl -k -u admin:<ADMIN_PASSWORD> https://<WAZUH_INDEXER_IP>:9200/_cat/nodes?v`

That's it!

## **Installing Wazuh server**

System requirements for Wazuh server are a bit on the lower side compared to the indexer:

**Minimum** 2 GB RAM, 2 CPU cores

**Recommended** 4 GB RAM, 8 CPU cores.

For disk space requirements, this again depends on the environment, and using the previous example of 80 workstations, 10 servers and 10 network devices, the storage needed on the Wazuh server for 90 days of alerts is 6 GB according to the documentation. I'll just go ahead and put 32 GB (thin provisioned) and the recommended specs. 

As said previously, I am installing the server component to another host as instructed by the documentation, so I have to get the installation script again:

`curl -sO https://packages.wazuh.com/4.7/wazuh-install.sh`

I naturally already forgot that I need the wazuh-install-files.tar on all hosts, so I first transferred them over with `scp -r wazuh-install-files.tar user@wazuhserver:/home/user` and ran the following command (the config.yml file is included in the install files):

`# bash wazuh-install.sh --wazuh-server wazuh-1`

As long as the wazuh-install-files are present, the installation should complete without any issues, and checking the provided log at `/var/log/wazuh-install.log` indeed confirms that the installation was successful, and `systemctl status wazuh-manager filebeat` shows both services up and running (confusingly it's not wazuh-server?), Filebeat being one of the main components of the server component, used to send events and alerts to the Wazuh indexer.

## **Installing Wazuh dashboard**

Since it is not explicitly mentioned in the documentation where the dashboard component should reside, I'm going to try to have it on the same server as the server. 

System requirements are as follows:

**Minimum** 4 GB RAM, 2 CPU cores

**Recommended** 8 GB RAM, 4 CPU cores.

(Shall see how the server + dashboard together works out)

Once again, the same wazuh-install.sh script is needed:

`# bash wazuh-install.sh  --wazuh-dashboard dashboard`

The default port for the GUI is 443, but this can be changed with the optional parameter `-p|--port <port_number>` during the installation. After running the command, you should now be able to access the GUI from https://ipaddress:possiblecustomport. The password should be echoed by the installation script as well, but in any case it and any other password will be present in `wazuh-passwords.txt` as a part of the wazuh-install-files.

![wazuhgui](/wazuh/wazuhgui.png)

That's about it to get going.

## **Installing agents** 

In order to use all the cool features of Wazuh, you need to install an agent to each device that you want to monitor. This is taken care of by the agent enrolment process, which registers and authorises members to use Wazuh. Each agent will have a unique key that is used to encrypt communication between the agent and the manager. The agent enrolment also validates the identity of each of the agents communicating with the manager.

Once again there's a few ways to do things, and when it comes to enrolling agents, you can

1) Enroll via agent configuration, which makes it so that any installed agent will be able to automatically request and import their own key; **this is the method Wazuh recommends**
2) Enroll via manager API, and with this method the user requests the key from the manager API and then manually imports it to the agent. (You can also run the manage_agents program from /var/ossec/bin/manage_agents and add them that way)

Since I have already installed all the required components, I can already start enrolling agents, as long as I have opened ports 1514/tcp and 1515/tcp on the Wazuh manager internally so my agents can communicate with it. I will open these ports on the server where Wazuh server and dashboard was installed, as the indexer primarily just handles and stores the data, whereas the server does all the legwork, including the agent enrolment. Port 1514 is used for agent communication, 1515 for enrolment via automatic agent request. If enrolment is done via manager API, port 55000/tcp needs to be open instead of 1515.

Since I am using the automatic enrolment as recommended, I log into the Wazuh dashboard, click on the drop-down menu and choose Agents:

![wazuhagents](/wazuh/wazuhagents.png)

Next, I will have to 

1) Choose the operating system of the agent
2) Set the server address (this is where Wazuh server was installed)
3) (Optional) assign a custom name to the agent. The agent name must be unique, and cannot be changed once the agent has been enrolled.
4) (Optional) choose which group the agent should reside in. For now, I'll choose the default one.

After entering all these details, I get an installation script to install the agent on a client. Since I'm installing the first agent on Windows, I get this PowerShell script:

`Invoke-WebRequest -Uri https://packages.wazuh.com/4.x/windows/wazuh-agent-4.7.4-1.msi -OutFile ${env.tmp}\wazuh-agent; msiexec.exe /i ${env.tmp}\wazuh-agent /q WAZUH_MANAGER='server2' WAZUH_AGENT_NAME='Akali' WAZUH_REGISTRATION_SERVER='server2' `

I open an elevated PowerShell window, enter in the script and then run `NET START WazuhSvc` to start the service, as instructed by the agent page. The first agent has now been enrolled. 

By default, as long as the required ports are open on the Wazuh server upon enrolment, the agent should show up in the Agents dropdown and show information such as the OS (down to the build number), IP address, version of Wazuh agent and even compliance with any chosen, default framework.

![image-20240507183651673](/wazuh/wazuhagentview.png)

As this is a Windows client, I can even see the CIS benchmark on this specific machine. Seems like it did quite poorly.

![image-20240507183902626](/wazuh/cisbenchmark.png)

You can even see further inventory data such as all the applications installed, the network interfaces, system specifications, installed Windows updates (if on Windows) and even generate a report based on all of this. All of this and more, for free. 

![image-20240507183902626](/wazuh/wazuh_agent_inventory.png)

Next, I want to check out any possible vulnerabilities on this machine. 


**Vulnerability detection**

Vulnerability detection for some reason is not enabled by default. Once enabled, Wazuh will periodically collect a list of installed applications from any client with an agent installed. This list is stored in a local SQLite database on the Wazuh server, and this database can be viewed on the host by [following these instructions.](https://documentation.wazuh.com/current/user-manual/capabilities/vulnerability-detection/how-it-works.html#how-it-works) Additionally, the Wazuh server continuously collects CVEs from a handful of repositories (such as Red Hat, Canonical and Nist) and builds a global vulnerability database from them to compare the information with the application inventory data of each agent. The update interval of the CVEs can be increased: by default it seems to be 12 hours.

By default, the compatible operating systems for vulnerability detection are several flavours of Linux including Red Hat, Ubuntu and Arch Linux and obviously macOS and Windows. You can see a more detailed list [here](https://documentation.wazuh.com/current/user-manual/capabilities/vulnerability-detection/how-it-works.html#compatibility-matrix) and also to add unsupported systems (like making Kali Linux use the Debian vulnerability feed), check [here.](https://documentation.wazuh.com/current/user-manual/capabilities/vulnerability-detection/allow-os.html#configuring-vulnerability-detector-to-include-unsupported-systems)

There's three types of scan types:

- **Baseline.** This is triggered the first time the vulnerability detection module is enabled; performs a full scan of the OS and every package installed, creates a CVE inventory and generates alerts if vulnerabilities are found. 
- **Full scan**. Same thing as Baseline except this is done after the initial scan, according to the `min_full_scan_interval` in the configuration file. By default this full scan is made every 6 hours, but is configurable.  The documentation does mention that this interval is meant to protect the manager's performance by not running the scans too often, so you may have worse performance if the interval is too short, and in a bigger environment I can see this causing some problems.
- **Partial scan.** This scans just new packages and generates alerts if there is any cause for concern.

To start running vulnerability scans, add the following block of settings to the shared agent configuration file at `/var/ossec/etc/shared/default/agent.conf`: 

```
<wodle name="syscollector">
   <disabled>no</disabled>
   <interval>1h</interval>
   <os>yes</os>
   <packages>yes</packages>
   <hotfixes>yes</hotfixes>
</wodle>
```

This basically pushes out the above settings to every agent in the group `default`, and this way one can add any other desirable configurations to be pushed out to all the agents as well. Next, enable the vulnerability detector module in the Wazuh server configuration file at `/var/ossec/etc/ossec.conf` (change enabled from no to yes):

```
 <vulnerability-detector>
    <enabled>yes</enabled>
    <interval>5m</interval>
    <min_full_scan_interval>6h</min_full_scan_interval>
    <run_on_start>yes</run_on_start> 
```

Additionally, you have to enable each OS to be checked for vulnerabilities below the detector module, for example:
```
<!-- Ubuntu OS vulnerabilities -->
    <provider name="canonical">
      <enabled>yes</enabled>
      <os>trusty</os>
      <os>xenial</os>
      <os>bionic</os>
      <os>focal</os>
      <os>jammy</os>
      <update_interval>1h</update_interval>
    </provider>
```
You can either enable them all or just specific ones you'll be using. For changes to take effect, you have to restart the wazuh-manager with systemctl: `# systemctl restart wazuh-manager`

I can already see after doing these actions how the same machine that didn't quite pass the CIS benchmark also has some vulnerabilities. Here is how that looks like on the GUI side:

![image-20240508181931162](/wazuh/vulnerabilities.png)

![image-20240508181942900](/wazuh/vulnerabilities2.png)

As you can see, you can list things by name, CVSS score, detection time and so on.  There's also the Wazuh API that can be used for a variety of things and I'll possibly make a post on that later on.

## **Syncing agents over the internet** 

Because I want to be able to sync my agents over the internet, I have opened ports 1514/tcp and 1515/tcp to my Wazuh server. Because I'm using pfSense as my firewall, I did this by going to Firewall > NAT > Port Forward, and made a new rule that redirects traffic destined to ports 1514 and 1515 to my Wazuh Server. This also automatically makes a rule in the WAN interface to allow these same ports. 

By doing this I was able to enroll my family member's laptop as well as their ROG Ally and have them immediately show up in Wazuh. In order to sync the agents over the internet, I have set my public IP address as the host for the agent; I'll have to come up with a better solution for this later on, perhaps by using CloudFlare tied to my domain.

## **Quick overview of other features**  

In addition to viewing vulnerabilities of an agent, you can also check out security events of one (or all of them in the main menu > security information management > security events):

![securityevents](/wazuh/securityevents.png)

As you can see, this shows you the total amount of security related events, amount of authentication failures, alerts level 12 or above (what the levels mean is better explained [here](https://documentation.wazuh.com/current/user-manual/ruleset/rules-classification.html), basically 12 is a high importance event that includes error or warning messages from the system, kernel etc. and could include attacks against a specific application.)

You can see each event in a neat list which shows the MITRE ATT&CK ID, tactics used (if malicious), description, severity level and Rule ID:

![securityevents2](/wazuh/securityevents2.png)

Each event can be expanded to show more details such as the JSON content of the event, and you can even click on each MITRE ATT&CK ID to show more details about each ID:

![securityevents3](/wazuh/securityevents3.png)

![securityevents4](/wazuh/securityevents4.png)

You can even monitor the integrity of each agent, including registry keys and even specific files in any location you want to specify in the ossec.conf file of an agent (or all the agents for that matter):

![integritymonitoring](/wazuh/integritymonitoring.png)

Finally, you may also directly see each agent's compliance with any of the listed frameworks, with each requirement listed and monitor which requirements are being met and which aren't:

![pcidss](/wazuh/pcidss.png)

![pcidss2](/wazuh/pcidss2.png)

## **Wrapping up**  

![wazuhdiagram](/wazuh/wazuhdiagram.png)

In this post I have successfully installed and configured Wazuh index, server and dashboard. I thought installing the server and the dashboard to the same host could cause some problems, but I haven't had any issues with my first five agents. Initially I was going to do even more things than covered here, but for this to be more digestible, I thought it best to wrap it up here and continue in more posts later with things such as:

- Adding pfSense to Wazuh
- Making separate groups for servers and workstations
- Enabling VirusTotal integration
- Looking into configuring active response
- Coming up with a better way to set my manager's IP for agents (FQDN perhaps?)

For now, thank you for reading my post! 
